<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Ease your cache</title>
        <link rel="stylesheet" href="http://img.netlumination.com/css/styles.0.1.0.css"/>
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
    </head>
    <body>
        <div class="container">
            <header class="well">
                <h1 class="page-header">Ease your cache</h1>
                
                <a class="badge badge-success text-white" href="/curated-reading-list/">« A Curated Reading...</a>&nbsp;&nbsp;
                
                <a class="badge badge-success text-white" href="/">Home</a>
                
                &nbsp;&nbsp;<a class="badge badge-success text-white" href="/build-automation/">Build automation »</a>
                
            </header>
            <section>
                <h2>Easing: 4 sentence intro</h2>

<p>Easing is how an animation moves from initial state to completion over time. Easing is described by an equation or set of
equations. Using easing will make your animation look more polished and appealing.</p>

<p><a href="http://easings.net/">Here</a> are visualization for several easing equations.</p>

<h2>Caching</h2>

<p>Easing functions can get pretty complicated. They often include notoriously slow methods like sine or cosine. This
means that you should cache your easing results.</p>

<p>The problem is that if your easing equations are not normalized to one unit of time and one unit of completion, then
this caching will not be useful.</p>

<p>In other words, pass in only a normalized <code>t</code>, so that you have the maximum chance of hitting a cached <code>y</code>. Basically,
we&#39;re drawing a curve, and once we calculate a point on that curve, we want to cache our calculation. If we don&#39;t
normalize our easing equation then we must draw many curves, but if we do normalize then we only need one curve, and
so we can store points on that single curve from all our animations that share the same easing function.</p>

<p>Below is an example for easing in and out with a sine function:</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="nx">easeInOutSine</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Our cache in a closure</span>
    <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="c1">// The actual easing function returned to the user</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// If the value is not in the cache, put it in the cache</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">t</span><span class="p">])</span> <span class="p">{</span>
       <span class="nx">cache</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// We return from the cache, knowing our value is there</span>
    <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">t</span><span class="p">];</span>
    <span class="p">};</span>
<span class="p">}());</span>
</code></pre></div>
<p><a href="http://jsfiddle.net/pajtai/VX5xK/show/"><strong>jsFiddle using the above</strong></a> - (<a href="http://jsfiddle.net/pajtai/VX5xK/">code</a>)</p>

<p>Or, if you are an <a href="http://underscorejs.org/">underscore</a> fan:</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="c1">// Use underscores built in memoize for caching</span>
<span class="nx">easeInOutSine</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="nx">t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>
<p><a href="http://jsfiddle.net/pajtai/8kU85/show/"><strong>jsFiddle using the above</strong></a> - (<a href="http://jsfiddle.net/pajtai/8kU85/">code</a>)</p>

<p>This complicates your animation equation, since you have to normalize your time and change intervals, but the
payoff is a smoother animation, since you&#39;re doing fewer computations.</p>

<p>The above is better for caching then for example something like:</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="c1">// This is hard to cache, since there&#39;s going to be cache entries for each combination of arguments</span>
<span class="nx">easeInOutSine</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">startValue</span><span class="p">,</span> <span class="nx">changeInValue</span><span class="p">,</span> <span class="nx">msElapsed</span><span class="p">,</span> <span class="nx">msDuration</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="nx">changeInValue</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">msElapsed</span><span class="o">/</span><span class="nx">msDuration</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">startValue</span><span class="p">;</span>
<span class="p">},</span>
</code></pre></div>
<p>Normalizing your easing equations to improve caching is fine and dandy, but it certainly isn&#39;t very user friendly unless
your easing equation or animation engine handles the normalization. Then you can go back to having nice arguments.</p>

<p>The disadvantage of rolling your normalization into your easing equation is that you have to recalculate the change
in value from the start and end value at each tick. Also, it doesn&#39;t seem like normalization is a job for an easing
 equation. So, let&#39;s put the normalization into the animation engine.</p>

<p>For example, adding normalization to <code>easeInOutSine</code> and moving a box around would make something like:</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="c1">// The animation equation with user friendly arguments</span>
<span class="c1">// This will take care of normalization before calling the easing equation,</span>
<span class="c1">// * tickHook - function that get called on each tick with the updated number</span>
<span class="c1">// * startNum - initial value</span>
<span class="c1">// * endNum - final value</span>
<span class="c1">// * duration - how long animation last in milliseconds</span>
<span class="c1">// * callback - (optional) function to call when animation finishes</span>
<span class="c1">// * easingEq - (optional) easing equation</span>
    <span class="kd">var</span> <span class="nx">animate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tickHook</span><span class="p">,</span> <span class="nx">startNum</span><span class="p">,</span> <span class="nx">endNum</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">easingEq</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">easingEq</span> <span class="o">=</span> <span class="nx">easingEq</span> <span class="o">||</span> <span class="nx">easing</span><span class="p">.</span><span class="nx">easeInOutSine</span><span class="p">,</span>
            <span class="nx">changeInNum</span> <span class="o">=</span> <span class="nx">endNum</span> <span class="o">-</span> <span class="nx">startNum</span><span class="p">,</span>
            <span class="nx">startTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>

            <span class="c1">// The engine that runs the animation</span>
            <span class="nx">engine</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>

                    <span class="c1">// Calculate the normalized time elapsed for the easing function</span>
                    <span class="nx">timeNorm</span> <span class="o">=</span> <span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">startTime</span><span class="p">)</span> <span class="o">/</span> <span class="nx">duration</span><span class="p">,</span>

                    <span class="c1">// Calculate the normalized completion from the normalized time</span>
                    <span class="c1">// using the easing function</span>
                    <span class="nx">completionNorm</span> <span class="o">=</span> <span class="nx">easingEq</span><span class="p">(</span><span class="nx">timeNorm</span><span class="p">),</span>

                    <span class="c1">// &quot;un-normalize&quot; to calculate the new actual number</span>
                    <span class="nx">newNum</span> <span class="o">=</span> <span class="nx">startNum</span> <span class="o">+</span> <span class="nx">completionNorm</span> <span class="o">*</span> <span class="nx">changeInNum</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">startTime</span> <span class="o">&gt;</span> <span class="nx">duration</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">callback</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                    <span class="c1">// Update interested parties with the new number once per tick</span>
                    <span class="nx">tickHook</span><span class="p">(</span><span class="nx">newNum</span><span class="p">);</span>

                    <span class="c1">// Kick off the next tick</span>
                    <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">engine</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">};</span>

        <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">engine</span><span class="p">);</span>
    <span class="p">},</span>
<span class="c1">// and the implentation goes here...</span>
</code></pre></div>
<p><a href="http://jsfiddle.net/pajtai/gAAp2/show"><strong>jsFiddle example</strong></a> (<a href="http://jsfiddle.net/pajtai/gAAp2/">code</a>)</p>

<p>In fact the caching could probably move out of the easing equation too in order to keep the equation clean. You can
roll your own caching (a.k.a. memoization) function, or you can use something like <a href="http://underscorejs.org/#memoize"><strong>Underscore&#39;s memoize</strong></a>.</p>

            </section>
            <footer>
                
                <p class="tags">
    
    <a href="/tags.html#javascript" class="badge badge-inverse">javascript</a>&nbsp;
    
    <a href="/tags.html#caching" class="badge badge-inverse">caching</a>&nbsp;
    
</p>
                
                <p class="well">To comment <a href="http://twitter.com/home?status=@Peter_Ajtai">tweet @Peter_Ajtai</a> or <a href="https://github.com/pajtai/Netlumination.com/issues">submit an issue on GitHub.</p>
                
                <div class="pull-right">
                    <h3 class="logo"><a href="/">Netlumination</a></h3>

                </div>
            </footer>
        </div>
    </body>
</html>